<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Flow Test - Pollen Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .success {
            color: #22c55e;
            font-weight: bold;
        }
        .error {
            color: #ef4444;
            font-weight: bold;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        pre {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
        }
        .risk-display {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .risk-low { background-color: #dcfce7; color: #166534; }
        .risk-moderate { background-color: #fef3c7; color: #92400e; }
        .risk-high { background-color: #fed7aa; color: #c2410c; }
        .risk-very-high { background-color: #fecaca; color: #dc2626; }
    </style>
</head>
<body>
    <h1>Pollen Tracker Full Flow Test</h1>
    <p>This page tests the complete user flow from location detection to personalized risk calculation.</p>
    
    <div class="test-section">
        <h2>Step 1: Environment Setup</h2>
        <div id="env-check">Checking environment...</div>
        <div id="api-status">API Status: Unknown</div>
    </div>
    
    <div class="test-section">
        <h2>Step 2: Location Detection</h2>
        <button onclick="testLocationFlow()">Test Location Detection</button>
        <div id="location-result">Click to test location detection</div>
    </div>
    
    <div class="test-section">
        <h2>Step 3: Pollen Data Fetch</h2>
        <button onclick="testPollenFlow()" id="pollen-btn" disabled>Test Pollen API (needs location)</button>
        <div id="pollen-result">Location needed first</div>
    </div>
    
    <div class="test-section">
        <h2>Step 4: Risk Calculation</h2>
        <div>
            <label>Tree Sensitivity (1-10): <input type="range" id="tree-sensitivity" min="1" max="10" value="5"></label>
            <span id="tree-value">5</span>
        </div>
        <div>
            <label>Grass Sensitivity (1-10): <input type="range" id="grass-sensitivity" min="1" max="10" value="5"></label>
            <span id="grass-value">5</span>
        </div>
        <div>
            <label>Weed Sensitivity (1-10): <input type="range" id="weed-sensitivity" min="1" max="10" value="5"></label>
            <span id="weed-value">5</span>
        </div>
        <button onclick="calculateRisk()" id="risk-btn" disabled>Calculate Personal Risk (needs pollen data)</button>
        <div id="risk-result">Pollen data needed first</div>
    </div>
    
    <div class="test-section">
        <h2>Step 5: Complete Integration Test</h2>
        <button onclick="runFullTest()">Run Complete Flow Test</button>
        <div id="full-test-result">Click to run the complete integration test</div>
    </div>

    <script type="module">
        // Global state for test flow
        window.testState = {
            apiKey: null,
            location: null,
            pollenData: null,
            processedData: null
        };

        // Risk calculation functions (simplified versions of the actual app functions)
        function calculatePollenRiskScore(pollenIndex, userSensitivity) {
            pollenIndex = Math.max(0, Math.min(5, pollenIndex));
            userSensitivity = Math.max(1, Math.min(10, userSensitivity));
            return Math.round((pollenIndex * userSensitivity) / 10 * 10) / 10;
        }

        function getRiskLevel(riskScore) {
            if (riskScore < 2) return 'low';
            if (riskScore < 5) return 'moderate';
            if (riskScore < 8) return 'high';
            return 'very-high';
        }

        function calculatePersonalizedRisk(pollenData, sensitivity) {
            const treeIndex = pollenData.dailyInfo[0].pollenTypeInfo?.find(p => p.code === 'TREE')?.indexInfo?.value || 0;
            const grassIndex = pollenData.dailyInfo[0].pollenTypeInfo?.find(p => p.code === 'GRASS')?.indexInfo?.value || 0;
            const weedIndex = pollenData.dailyInfo[0].pollenTypeInfo?.find(p => p.code === 'WEED')?.indexInfo?.value || 0;

            const treeScore = calculatePollenRiskScore(treeIndex, sensitivity.tree);
            const grassScore = calculatePollenRiskScore(grassIndex, sensitivity.grass);
            const weedScore = calculatePollenRiskScore(weedIndex, sensitivity.weed);
            
            const overallScore = (treeScore + grassScore + weedScore) / 3;
            const overallRisk = getRiskLevel(overallScore);

            return {
                overallScore: Math.round(overallScore * 10) / 10,
                overallRisk,
                pollenTypes: {
                    tree: { index: treeIndex, score: treeScore, risk: getRiskLevel(treeScore) },
                    grass: { index: grassIndex, score: grassScore, risk: getRiskLevel(grassScore) },
                    weed: { index: weedIndex, score: weedScore, risk: getRiskLevel(weedScore) }
                }
            };
        }

        // Environment check
        function checkEnvironment() {
            const envCheck = document.getElementById('env-check');
            const apiStatus = document.getElementById('api-status');
            
            const apiKey = import.meta.env.VITE_GOOGLE_API_KEY;
            
            if (!apiKey) {
                envCheck.innerHTML = '<span class="error">❌ Google API Key not found</span>';
                apiStatus.innerHTML = 'API Status: <span class="error">Not Configured</span>';
                return false;
            } else {
                envCheck.innerHTML = '<span class="success">✅ Google API Key found</span>';
                apiStatus.innerHTML = 'API Status: <span class="success">Configured</span>';
                window.testState.apiKey = apiKey;
                return true;
            }
        }

        // Location detection test
        window.testLocationFlow = async function() {
            const locationResult = document.getElementById('location-result');
            locationResult.innerHTML = '<span class="loading">Testing location detection...</span>';
            
            if (!navigator.geolocation) {
                locationResult.innerHTML = '<span class="error">❌ Geolocation not supported</span>';
                return;
            }
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 300000
                    });
                });
                
                const location = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                
                window.testState.location = location;
                
                locationResult.innerHTML = `
                    <span class="success">✅ Location detected successfully</span><br>
                    <strong>Coordinates:</strong> ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}<br>
                    <strong>Accuracy:</strong> ${position.coords.accuracy}m
                `;
                
                // Enable next step
                document.getElementById('pollen-btn').disabled = false;
                
            } catch (error) {
                let errorMessage = 'Unknown error';
                if (error.code === 1) errorMessage = 'Permission denied';
                else if (error.code === 2) errorMessage = 'Position unavailable';  
                else if (error.code === 3) errorMessage = 'Timeout';
                
                locationResult.innerHTML = `<span class="error">❌ Location error: ${errorMessage}</span>`;
            }
        };

        // Pollen API test
        window.testPollenFlow = async function() {
            const pollenResult = document.getElementById('pollen-result');
            
            if (!window.testState.location) {
                pollenResult.innerHTML = '<span class="error">❌ Location required first</span>';
                return;
            }
            
            pollenResult.innerHTML = '<span class="loading">Fetching pollen data...</span>';
            
            try {
                const { latitude, longitude } = window.testState.location;
                
                const params = new URLSearchParams({
                    key: window.testState.apiKey,
                    'location.latitude': latitude.toString(),
                    'location.longitude': longitude.toString(),
                    days: '3'
                });
                
                const response = await fetch(`https://pollen.googleapis.com/v1/forecast:lookup?${params.toString()}`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                window.testState.pollenData = data;
                
                pollenResult.innerHTML = `
                    <span class="success">✅ Pollen data fetched successfully</span><br>
                    <strong>Region:</strong> ${data.regionCode}<br>
                    <strong>Days available:</strong> ${data.dailyInfo.length}<br>
                    <strong>Today's pollen levels:</strong><br>
                    ${data.dailyInfo[0].pollenTypeInfo.map(p => 
                        `${p.code}: ${p.indexInfo?.value || 0}`
                    ).join(', ')}
                `;
                
                // Enable risk calculation
                document.getElementById('risk-btn').disabled = false;
                
            } catch (error) {
                pollenResult.innerHTML = `<span class="error">❌ Pollen API error: ${error.message}</span>`;
            }
        };

        // Risk calculation test
        window.calculateRisk = function() {
            const riskResult = document.getElementById('risk-result');
            
            if (!window.testState.pollenData) {
                riskResult.innerHTML = '<span class="error">❌ Pollen data required first</span>';
                return;
            }
            
            const sensitivity = {
                tree: parseInt(document.getElementById('tree-sensitivity').value),
                grass: parseInt(document.getElementById('grass-sensitivity').value),
                weed: parseInt(document.getElementById('weed-sensitivity').value)
            };
            
            const processedData = calculatePersonalizedRisk(window.testState.pollenData, sensitivity);
            window.testState.processedData = processedData;
            
            riskResult.innerHTML = `
                <span class="success">✅ Risk calculation completed</span>
                <div class="risk-display risk-${processedData.overallRisk}">
                    <strong>Overall Risk: ${processedData.overallRisk.toUpperCase()}</strong><br>
                    Risk Score: ${processedData.overallScore}
                </div>
                <strong>Individual Risks:</strong><br>
                🌳 Tree: ${processedData.pollenTypes.tree.risk} (${processedData.pollenTypes.tree.score})<br>
                🌾 Grass: ${processedData.pollenTypes.grass.risk} (${processedData.pollenTypes.grass.score})<br>
                🌿 Weed: ${processedData.pollenTypes.weed.risk} (${processedData.pollenTypes.weed.score})
            `;
        };

        // Full integration test
        window.runFullTest = async function() {
            const fullResult = document.getElementById('full-test-result');
            fullResult.innerHTML = '<span class="loading">Running complete integration test...</span>';
            
            let results = [];
            
            try {
                // Step 1: Environment check
                results.push('✅ Environment check: API key configured');
                
                // Step 2: Location detection
                fullResult.innerHTML = '<span class="loading">Testing location detection...</span>';
                await testLocationFlow();
                if (window.testState.location) {
                    results.push('✅ Location detection: Success');
                } else {
                    results.push('❌ Location detection: Failed');
                    throw new Error('Location detection failed');
                }
                
                // Step 3: Pollen data fetch
                fullResult.innerHTML = '<span class="loading">Testing pollen API...</span>';
                await testPollenFlow();
                if (window.testState.pollenData) {
                    results.push('✅ Pollen API: Success');
                } else {
                    results.push('❌ Pollen API: Failed');
                    throw new Error('Pollen API failed');
                }
                
                // Step 4: Risk calculation
                calculateRisk();
                if (window.testState.processedData) {
                    results.push('✅ Risk calculation: Success');
                } else {
                    results.push('❌ Risk calculation: Failed');
                    throw new Error('Risk calculation failed');
                }
                
                // Final success
                fullResult.innerHTML = `
                    <span class="success">🎉 Complete integration test PASSED!</span><br><br>
                    <strong>Results:</strong><br>
                    ${results.join('<br>')}<br><br>
                    <div class="risk-display risk-${window.testState.processedData.overallRisk}">
                        <strong>Final Risk Assessment: ${window.testState.processedData.overallRisk.toUpperCase()}</strong><br>
                        Score: ${window.testState.processedData.overallScore}<br>
                        Location: ${window.testState.location.latitude.toFixed(4)}, ${window.testState.location.longitude.toFixed(4)}
                    </div>
                `;
                
            } catch (error) {
                fullResult.innerHTML = `
                    <span class="error">❌ Integration test FAILED</span><br><br>
                    <strong>Completed steps:</strong><br>
                    ${results.join('<br>')}<br><br>
                    <strong>Error:</strong> ${error.message}
                `;
            }
        };

        // Update sensitivity values display
        document.addEventListener('DOMContentLoaded', function() {
            ['tree', 'grass', 'weed'].forEach(type => {
                const slider = document.getElementById(`${type}-sensitivity`);
                const display = document.getElementById(`${type}-value`);
                
                slider.addEventListener('input', function() {
                    display.textContent = this.value;
                });
            });
        });

        // Initialize
        checkEnvironment();
    </script>
</body>
</html>